package com.mpi.InstantPaymentService.service.implementation;

import com.ibm.as400.access.DataQueue;
import com.mpi.InstantPaymentService.component.OutputDataQueue;
import com.mpi.InstantPaymentService.model.PaymentReceivedLogEntity;
import com.mpi.InstantPaymentService.service.dao.DataQueueConnectionService;
import com.mpi.InstantPaymentService.service.intf.DataQServiceInterface;
import com.mpi.InstantPaymentService.util.UtilityClass;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Properties;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

@Slf4j
@Service
public class DataQService implements DataQServiceInterface {

    @Autowired
    private DataQueueConnectionService dataQueueConnectionService;

    @Autowired
    private OutputDataQueue outputDataQueue;

    @Override
    public synchronized PaymentReceivedLogEntity processMessage(String message) {
        try {
            log.info("message dataQ: " + message);

            InputMessageUtil inpMsg = new InputMessageUtil();
            inpMsg.splitMessage(message);

            PaymentReceivedLogEntity logtx =
                    saveIncomingLog(inpMsg.getParsedInput()[7], inpMsg.getParsedInput()[10]);

            DataQueue dataqIn = dataQueueConnectionService.getInputQueue();
            message = formatStringToDtaQ(message);

            log.info("Writing to DataQueue: " + message);
            dataqIn.write(message);

            return logtx;
        } catch (Exception e) {
            log.error("Error processing message", e);
            return null;
        }
    }

    private String getProperty(String key) {
        Properties prop = new Properties();
        try (InputStream is =
                     Files.newInputStream(Paths.get("C:/GXIBillsPayment/properties/dataq.properties"))) {
            prop.load(is);
        } catch (IOException e) {
            log.error("Error loading properties", e);
        }
        return prop.getProperty(key);
    }

    private String formatStringToDtaQ(String message) {

        StringBuilder stringOutput = new StringBuilder();
        StringBuilder stringOutputLog = new StringBuilder();

        InputMessageUtil inpMsg = new InputMessageUtil();
        inpMsg.splitMessage(message);

        String clientClode = inpMsg.getParsedInput()[0];
        clientClode = Integer.toString(Integer.parseInt(clientClode));
        String requestMessage = inpMsg.getParsedInput()[1];
        String invoiceNo = inpMsg.getParsedInput()[2];
        String acctNo = inpMsg.getParsedInput()[3];
        String cbcCode = inpMsg.getParsedInput()[4];
        String currDate = UtilityClass.getCurrentDateFormat("MMddyy");
        String payAmt = inpMsg.getParsedInput()[5];
        String tranCode = inpMsg.getParsedInput()[6];
        String tranId = inpMsg.getParsedInput()[7];

        String sourceAcc = "";
        String sourceCBCCode = "";
        String transType = "";

        if (!clientClode.equals("2")) {
            sourceAcc = inpMsg.getParsedInput()[8];
            sourceCBCCode = inpMsg.getParsedInput()[9];
            transType = inpMsg.getParsedInput()[10];
        }

        String senderName = inpMsg.getParsedInput()[11];
        int senderNameSize = 60;

        // ==== MAIN DATA QUEUE STRING ====

        stringOutput.append(UtilityClass.addRightPad(clientClode,
                Integer.parseInt(getProperty("CLIENT_CODE_LENGTH")), " "));
        stringOutput.append(UtilityClass.addRightPad(requestMessage,
                Integer.parseInt(getProperty("REQUEST_LENGTH")), " "));
        stringOutput.append(UtilityClass.addLeftPad(invoiceNo,
                Integer.parseInt(getProperty("INVOICE_NO_LENGTH")), "0"));

        if (cbcCode.equalsIgnoreCase("MPI") && acctNo.length() < 11) {
            acctNo = UtilityClass.addLeftPad(acctNo, 11, "0");
        }

        stringOutput.append(UtilityClass.addRightPad(acctNo,
                Integer.parseInt(getProperty("ACCTNO_LENGTH")), " "));
        stringOutput.append(UtilityClass.addRightPad(cbcCode,
                Integer.parseInt(getProperty("CBC_CODE_LENGTH")), " "));
        stringOutput.append(UtilityClass.addRightPad(currDate,
                Integer.parseInt(getProperty("CURR_DATE_LENGTH")), " "));
        stringOutput.append(UtilityClass.addLeftPad(payAmt,
                Integer.parseInt(getProperty("PAYAMT_LENGTH")), "0"));
        stringOutput.append(UtilityClass.addRightPad(tranCode,
                Integer.parseInt(getProperty("TRANCODE_LENGTH")), " "));
        stringOutput.append(UtilityClass.addLeftPad(tranId,
                Integer.parseInt(getProperty("TRAN_ID_LENGTH")), " "));

        if (!clientClode.equals("2")) {
            stringOutput.append(UtilityClass.addLeftPad(sourceAcc,
                    Integer.parseInt(getProperty("ACCTNO_LENGTH")), "0"));
            stringOutput.append(UtilityClass.addRightPad(sourceCBCCode,
                    Integer.parseInt(getProperty("CBC_CODE_LENGTH")), " "));
            stringOutput.append(transType);
        }

        stringOutput.append(
                UtilityClass.addRightPad(senderName, senderNameSize, " ")
        );

        // ==== LOG STRING (MASKED) ====

        stringOutputLog.append(UtilityClass.addRightPad(clientClode,
                Integer.parseInt(getProperty("CLIENT_CODE_LENGTH")), " "));
        stringOutputLog.append(UtilityClass.addRightPad(requestMessage,
                Integer.parseInt(getProperty("REQUEST_LENGTH")), " "));
        stringOutputLog.append(UtilityClass.addLeftPad(invoiceNo,
                Integer.parseInt(getProperty("INVOICE_NO_LENGTH")), "0"));

        String maskedAcct =
                IntStream.range(0, acctNo.length()).mapToObj(i -> "*").collect(Collectors.joining());

        stringOutputLog.append(UtilityClass.addRightPad(maskedAcct,
                Integer.parseInt(getProperty("ACCTNO_LENGTH")), " "));
        stringOutputLog.append(UtilityClass.addRightPad(cbcCode,
                Integer.parseInt(getProperty("CBC_CODE_LENGTH")), " "));
        stringOutputLog.append(UtilityClass.addRightPad(currDate,
                Integer.parseInt(getProperty("CURR_DATE_LENGTH")), " "));
        stringOutputLog.append(UtilityClass.addLeftPad(payAmt,
                Integer.parseInt(getProperty("PAYAMT_LENGTH")), "0"));
        stringOutputLog.append(UtilityClass.addRightPad(tranCode,
                Integer.parseInt(getProperty("TRANCODE_LENGTH")), " "));
        stringOutputLog.append(UtilityClass.addLeftPad(tranId,
                Integer.parseInt(getProperty("TRAN_ID_LENGTH")), " "));

        if (!clientClode.equals("2")) {
            String maskedSource =
                    IntStream.range(0, sourceAcc.length()).mapToObj(i -> "*").collect(Collectors.joining());
            stringOutputLog.append(UtilityClass.addLeftPad(maskedSource,
                    Integer.parseInt(getProperty("ACCTNO_LENGTH")), "0"));
            stringOutputLog.append(UtilityClass.addRightPad(sourceCBCCode,
                    Integer.parseInt(getProperty("CBC_CODE_LENGTH")), " "));
            stringOutputLog.append(transType);
        }

        stringOutputLog.append(
                UtilityClass.addRightPad(" " + senderName, senderNameSize, " ")
        );

        log.info("converted for dQ: " + stringOutput.toString());
        return stringOutput.toString();
    }

    private PaymentReceivedLogEntity saveIncomingLog(String tid, String transtype) {
        PaymentReceivedLogEntity logtx = new PaymentReceivedLogEntity();

        if ("VAL".equals(transtype)) {
            logtx.setTransactionId(tid);
            logtx.setCreditorName("VAL");
            logtx.setDebtorName("CDT");
            outputDataQueue.add(logtx);
        }
        return logtx;
    }
}